{% extends "layout_2_col.html" %}

{% load url from future %}

{% load currency_filters %}
{% load thumbnail %}
{% load product_tags %}
{% load i18n %}
{% load staticfiles %}


{% block extrahead %}

{{block.super}}

    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }

      .yoInfoWindow {
        wwidth:400px;
        padding:5px;
        mmargin:10px;
        bbborder-radius: 8px;
      }


img[src*="gstatic.com/"], img[src*="googleapis.com/"] {
max-width: none;
}


    </style>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key={{mapsKey}}&sensor=false">
    </script>

    <script type="text/javascript" src="{% static 'oscar/js/google-maps-spiderfier/oms.min.js' %}"></script>

    <script type="text/javascript">
      

     var markers = [];
     infoWindows = Array();


      function initialize() {
        var mapOptions = {
          center: new google.maps.LatLng(34., -118.244),
          zoom: 8,
          streetViewControl: false,
          mapTypeControl: false,
        };
        var map = new google.maps.Map(document.getElementById("map-canvas"),
            mapOptions);


        var oms = new OverlappingMarkerSpiderfier(map, {keepSpiderfied: true} );


        {% for res in spatial_results %}

          {% if res.object.get_location  %}
                  

           var myInfoWindow = new google.maps.InfoWindow({
              content: '<div class="yoInfoWindow" ><a href="{{ res.object.get_absolute_url }}" >{{res.object.title}}</a> </div>',
              {% comment %}
                             content: '<div class="yoInfoWindow" ><a href="{%url 'catalogue:index' %}?booth={{ res.object.stockrecord.partner.id }}" >{{res.object.stockrecord.partner.name}}</a> </div>',
                             {% endcomment %}
               maxWidth:400,
            

          });

          var marker = new google.maps.Marker({
              position: new google.maps.LatLng({{res.object.getLatLong.0}}, {{res.object.getLatLong.1}}),
              map: map,
              title: "{{res.object.title}}",
              infowindow: myInfoWindow,

          });

       oms.addListener('click', function(marker, event) {
        //marker.infowindow.setContent(marker.desc);
        //marker.infowindow.open(map, marker);
         this.infowindow.open(map, this);
        // for(var i=0; i < markers.length; i++){
        //     markers[i].infowindow.close();
        // }
       });

      // oms.addListener('spiderfy', function(markers) {
      //   marker.infowindow.close();
      // });

          google.maps.event.addListener(marker, 'click', function() {
         for(var i=0; i < markers.length; i++){
             markers[i].infowindow.close();
         }

            this.infowindow.open(map, this);
          });

          markers.push(marker);
          oms.addMarker(marker); 
          
            {% endif %}

          {% endfor %}

       


      }
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>

{% endblock %}


{% block title %}
    "{{ query }}" | {{ block.super }}
{% endblock %}

{% block breadcrumbs %}
    <ul class="breadcrumb">
        <li>
            <a href="{% url 'promotions:home' %}">{% trans "Home" %}</a>
            <span class="divider">/</span>
        </li>
        <li>
            {% trans "Search" %}
            <span class="divider">/</span>
        </li>
        <li class="active">"{{ query }}"</li>
    </ul>
{% endblock %}


{% block column_left %}



{% comment %}
    {#{{spatial_results}}#}

    {# TODO - generate this block automatically using the facets setting #}
    <h4>{% trans "Refine your search" %}</h4>
    <dl>
        {% if facet_data.category %}
            {% include 'search/partials/facet.html' with name='Category' items=facet_data.category %}
        {% endif %}

        {% if facet_data.price_range %}
            {% include 'search/partials/facet.html' with name='Price range' items=facet_data.price_range %}
        {% endif %}
    </dl>
{% endcomment %}
{% endblock %}

{% block headertext %}
    {% blocktrans with q=query %}
        <div style="font-size:0.8em">Products matching "{{ q }}" </div>
    {% endblocktrans %}
{% endblock %}

{% block content %}


<a href="javascript:history.back()" style="font-size:1.1em;float:right;margin-bottom:1.4em">Back to previous page</a>

        <section>
            <div class="mod">
                {% include "search/partials/pagination.html" %}
                <ol class="products three">
    {% for res in spatial_results %}

            {% if not "disabled" in res.object.status or request.user.is_admin or request.user == partner.user %}
                <li>{% render_product res.object %}</li>
            {% endif %}

    {% endfor %}

                </ol>

            </div>
        </section>
   

    {% if suggestion %}
        {% trans 'Did you mean' %} <a href="{% url 'search:search' %}?q={{ suggestion }}">{{ suggestion }}</a>?
    {% endif %}

    {% if page.object_list %}
        {% comment %}
        <section>
            <div class="mod">
                {% include "search/partials/pagination.html" %}
                <ol class="products four">
                    {% for result in page.object_list %}
                        {{result.object.status}}444
                        {#{% if not "disable" in result.object.status or request.user.is_staff %}#}
                        {% if False %}
                        <li>{% render_product result.object %}</li>
                        {% endif %}
                        }
                    {% endfor %}
                </ol>
                {% include "search/partials/pagination.html" %}
            </div>
        </section>
        {% endcomment %}
{% comment %}
          <section>
            <div class="mod">
                <ol class="products three">
                    {% for result in page.object_list %}
                      {% if not "disable" in result.object.status or request.user.is_staff %}
                        <li>{% render_product result.object %}</li>
                      {% endif %}
                    {% endfor %}
                </ol>
                {% include "partials/pagination.html" %}
            </div>
        </section>
{% endcomment %}

    {% else %}
        <p>{% trans 'No search results found.' %}</p>
    {% endif %}





          <div id="map-canvas" style="width:100%;height:300px;"> </div>
{% comment %}
         {% for res in spatial_results %}
           {% if res.object.get_location  %}
             {{res.object.title}}  {{res.object.getZipcode}}
             <br>
           {% endif %}
         {% endfor %}
{% endcomment %}

{% endblock %}
